<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exhibition Navigator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { margin: 0; font-family: system-ui; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
  .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); }
  .badge-vip { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  .badge-o2o { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  .badge-both { background: linear-gradient(135deg, #fbbf24 0%, #10b981 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  #svg-wrapper svg { cursor: grab; max-width: 100%; max-height: 100%; }
  #svg-wrapper svg:active { cursor: grabbing; }
  .info-highlight { background: #dbeafe; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 8px 0; }
  .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
  .btn-primary { background: #1f2937; color: white; }
  .btn-primary:hover { background: #374151; }
  
  /* Mini Map */
  .minimap {
    position: absolute;
    bottom: 80px;
    left: 20px;
    width: 200px;
    height: 150px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: none;
  }
  .minimap svg {
    width: 100%;
    height: 100%;
  }
  .minimap-viewport {
    fill: rgba(59, 130, 246, 0.3);
    stroke: #3b82f6;
    stroke-width: 2;
    pointer-events: none;
  }
</style>
</head>
<body>

<!-- Header -->
<header class="glass p-4 shadow-lg">
  <div class="flex justify-between items-center max-w-screen-2xl mx-auto">
    <div>
      <h1 class="text-2xl font-bold">üó∫Ô∏è Exhibition Navigator</h1>
      <p id="status" class="text-sm text-gray-600 mt-1">Upload files to begin</p>
    </div>
    <div class="flex gap-3">
      <button onclick="document.getElementById('svg-upload').click()" class="btn btn-primary">üìÑ SVG</button>
      <button onclick="document.getElementById('data-upload').click()" class="btn btn-primary">üìä Data</button>
      <input id="svg-upload" type="file" accept=".svg" style="display:none">
      <input id="data-upload" type="file" accept=".csv,.xlsx,.xls" style="display:none">
    </div>
  </div>
</header>

<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-80 glass p-4 overflow-y-auto">
    <h2 class="text-lg font-semibold mb-4">üîç Search & Filter</h2>
    
    <!-- Quick Search -->
    <div class="mb-4">
      <label class="text-sm font-medium">Quick Find Booth</label>
      <input id="quick-search" type="text" placeholder="e.g., A3C101" class="w-full mt-2 px-3 py-2 border rounded-lg" onkeypress="if(event.key==='Enter') quickSearch()">
    </div>

    <!-- VIP & O2O Filters -->
    <div class="mb-4">
      <label class="text-sm font-medium">Type</label>
      <div class="mt-2 space-y-2">
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-vip" type="checkbox" onchange="applyFilters()">
          <span class="badge-vip">‚≠ê VIP</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-o2o" type="checkbox" onchange="applyFilters()">
          <span class="badge-o2o">üîó O2O</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-both" type="checkbox" onchange="applyFilters()">
          <span class="badge-both">‚≠êüîó VIP+O2O</span>
        </label>
      </div>
    </div>

    <!-- Company -->
    <div class="mb-4">
      <label class="text-sm font-medium">Company</label>
      <input id="filter-company" type="text" placeholder="Search..." class="w-full mt-2 px-3 py-2 border rounded-lg" oninput="debounceFilter()">
    </div>

    <!-- Category T1 -->
    <div class="mb-4">
      <label class="text-sm font-medium">Category (T1)</label>
      <select id="filter-t1" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <!-- Sub-category T2 -->
    <div class="mb-4">
      <label class="text-sm font-medium">Sub-category (T2)</label>
      <select id="filter-t2" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <!-- Product Type T3 -->
    <div class="mb-4">
      <label class="text-sm font-medium">Product Type (T3)</label>
      <select id="filter-t3" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <!-- Products -->
    <div class="mb-4">
      <label class="text-sm font-medium">Products</label>
      <input id="filter-product" type="text" placeholder="Search products..." class="w-full mt-2 px-3 py-2 border rounded-lg" oninput="debounceFilter()">
    </div>

    <button onclick="resetAll()" class="w-full btn btn-primary">Reset All</button>

    <!-- Info Panel -->
    <div id="info-panel" class="mt-6 p-4 bg-white rounded-lg shadow-lg hidden">
      <h3 id="info-title" class="font-bold text-lg mb-3"></h3>
      <div id="info-content"></div>
    </div>

    <!-- Stats -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
      <p class="text-xs font-bold text-blue-800">STATISTICS</p>
      <p id="stats" class="text-sm text-blue-900 mt-1">No data</p>
    </div>
  </aside>

  <!-- Map -->
  <main class="flex-1 relative">
    <div id="svg-wrapper" class="w-full h-full"></div>
    
    <!-- Mini Map -->
    <div id="minimap" class="minimap">
      <svg id="minimap-svg"></svg>
    </div>
    
    <!-- Zoom Controls -->
    <div id="zoom-controls" class="absolute bottom-4 right-4 flex flex-col gap-2" style="display:none">
      <button onclick="zoom(0.8)" class="w-12 h-12 bg-white rounded-lg shadow-lg text-xl font-bold hover:bg-gray-50">+</button>
      <button onclick="zoom(1.2)" class="w-12 h-12 bg-white rounded-lg shadow-lg text-xl font-bold hover:bg-gray-50">‚àí</button>
      <button onclick="resetView()" class="w-12 h-12 bg-white rounded-lg shadow-lg text-lg hover:bg-gray-50">‚ü≤</button>
    </div>

    <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
      <div class="text-center">
        <div class="text-6xl mb-4">üó∫Ô∏è</div>
        <p class="text-lg">Upload SVG and Data files</p>
      </div>
    </div>
  </main>
</div>

<script>
let boothMap = {};
let boothData = [];
let selectedBooth = null;
let svgElement = null;
let viewBox = {x:0, y:0, w:1000, h:1000};
let originalViewBox = {x:0, y:0, w:1000, h:1000};
let isDragging = false;
let dragStart = {x:0, y:0};
let filterTimeout = null;

// Status
function setStatus(msg) {
  document.getElementById('status').textContent = msg;
}

// SVG Upload
document.getElementById('svg-upload').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    document.getElementById('svg-wrapper').innerHTML = text;
    document.getElementById('placeholder').style.display = 'none';
    
    svgElement = document.querySelector('#svg-wrapper svg');
    if (svgElement) {
      svgElement.style.width = '100%';
      svgElement.style.height = '100%';
      
      const bbox = svgElement.getBBox();
      viewBox = {x: bbox.x, y: bbox.y, w: bbox.width, h: bbox.height};
      originalViewBox = {...viewBox};
      updateViewBox();
      
      // Create minimap
      createMiniMap();
      
      document.getElementById('zoom-controls').style.display = 'flex';
      setStatus('‚úÖ SVG loaded');
      
      if (Object.keys(boothMap).length) bindBooths();
    }
  } catch (err) {
    setStatus('‚ùå Error loading SVG');
    console.error(err);
  }
};

// Create Mini Map
function createMiniMap() {
  const minimapSvg = document.getElementById('minimap-svg');
  const mainSvgClone = svgElement.cloneNode(true);
  
  minimapSvg.innerHTML = mainSvgClone.innerHTML;
  minimapSvg.setAttribute('viewBox', `${originalViewBox.x} ${originalViewBox.y} ${originalViewBox.w} ${originalViewBox.h}`);
  
  // Add viewport rectangle
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('class', 'minimap-viewport');
  rect.setAttribute('id', 'minimap-viewport-rect');
  minimapSvg.appendChild(rect);
  
  updateMiniMapViewport();
}

// Update Mini Map Viewport
function updateMiniMapViewport() {
  const rect = document.getElementById('minimap-viewport-rect');
  if (!rect) return;
  
  const scaleX = originalViewBox.w / viewBox.w;
  const scaleY = originalViewBox.h / viewBox.h;
  
  rect.setAttribute('x', viewBox.x);
  rect.setAttribute('y', viewBox.y);
  rect.setAttribute('width', viewBox.w);
  rect.setAttribute('height', viewBox.h);
  
  // Show minimap when zoomed
  const minimap = document.getElementById('minimap');
  if (scaleX > 1.2 || scaleY > 1.2) {
    minimap.style.display = 'block';
  } else {
    minimap.style.display = 'none';
  }
}

// Data Upload
document.getElementById('data-upload').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    let jsonData;
    
    if (file.name.endsWith('.csv')) {
      const text = await file.text();
      const parsed = Papa.parse(text, {header: true, delimiter: ';', skipEmptyLines: true});
      jsonData = parsed.data;
    } else {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type: 'array'});
      jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    }
    
    boothData = jsonData;
    
    // Build map
    boothMap = {};
    let vipCount = 0, o2oCount = 0, bothCount = 0;
    
    jsonData.forEach(row => {
      const id = String(row['Stand_no'] || '').trim().toUpperCase();
      if (!id) return;
      
      // VIP: Column T, value 1 or '1'
      const isVIP = row['VIP'] == 1 || String(row['VIP']).toLowerCase() === 'yes';
      // O2O: Column M, value 1 or '1'
      const isO2O = row['O2O'] == 1 || String(row['O2O']).toLowerCase() === 'yes';
      
      if (isVIP && isO2O) bothCount++;
      else if (isVIP) vipCount++;
      else if (isO2O) o2oCount++;
      
      boothMap[id] = {...row, isVIP, isO2O};
    });
    
    // Populate filters
    const t1 = [...new Set(jsonData.map(r => r['T1']).filter(Boolean))].sort();
    const t2 = [...new Set(jsonData.map(r => r['T2']).filter(Boolean))].sort();
    const t3 = [...new Set(jsonData.map(r => r['T3']).filter(Boolean))].sort();
    
    populateSelect('filter-t1', t1);
    populateSelect('filter-t2', t2);
    populateSelect('filter-t3', t3);
    
    document.getElementById('stats').textContent = 
      `${jsonData.length} exhibitors | ${bothCount} VIP+O2O | ${vipCount} VIP | ${o2oCount} O2O`;
    
    setStatus(`‚úÖ Loaded ${jsonData.length} exhibitors`);
    
    if (svgElement) bindBooths();
    
  } catch (err) {
    setStatus('‚ùå Error loading data');
    console.error(err);
  }
};

function populateSelect(id, options) {
  const select = document.getElementById(id);
  select.innerHTML = '<option value="">All</option>' + 
    options.map(o => `<option value="${o}">${o}</option>`).join('');
}

// Bind booths
function bindBooths() {
  if (!svgElement || !Object.keys(boothMap).length) return;
  
  const elements = svgElement.querySelectorAll('[id], text');
  
  elements.forEach(el => {
    let id = el.id || el.textContent?.trim();
    if (!id) return;
    
    id = id.toUpperCase();
    const booth = boothMap[id];
    
    if (!booth) {
      el.style.opacity = '0.2';
      el.style.filter = 'grayscale(1)';
      return;
    }
    
    el.style.cursor = 'pointer';
    el.onclick = () => selectBooth(id, booth);
  });
  
  applyFilters();
}

// Apply filters
function applyFilters() {
  if (!svgElement) return;
  
  const filters = {
    company: document.getElementById('filter-company').value.toLowerCase(),
    t1: document.getElementById('filter-t1').value,
    t2: document.getElementById('filter-t2').value,
    t3: document.getElementById('filter-t3').value,
    product: document.getElementById('filter-product').value.toLowerCase(),
    vip: document.getElementById('filter-vip').checked,
    o2o: document.getElementById('filter-o2o').checked,
    both: document.getElementById('filter-both').checked
  };
  
  const elements = svgElement.querySelectorAll('[id], text');
  let visible = 0;
  
  elements.forEach(el => {
    let id = el.id || el.textContent?.trim();
    if (!id) return;
    
    id = id.toUpperCase();
    const booth = boothMap[id];
    
    if (!booth) return;
    
    let match = true;
    
    if (filters.company && !booth['Company name']?.toLowerCase().includes(filters.company)) match = false;
    if (filters.t1 && booth['T1'] !== filters.t1) match = false;
    if (filters.t2 && booth['T2'] !== filters.t2) match = false;
    if (filters.t3 && booth['T3'] !== filters.t3) match = false;
    if (filters.product && !booth['Exhibited products']?.toLowerCase().includes(filters.product)) match = false;
    
    // Badge filters
    if (filters.both && !(booth.isVIP && booth.isO2O)) match = false;
    if (filters.vip && !filters.both && !booth.isVIP) match = false;
    if (filters.o2o && !filters.both && !booth.isO2O) match = false;
    
    if (!match) {
      el.style.opacity = '0.1';
      el.style.filter = 'grayscale(1)';
      return;
    }
    
    visible++;
    el.style.opacity = '1';
    el.style.filter = '';
    
    // VIP+O2O (Both) - Special star effect
    if (booth.isVIP && booth.isO2O) {
      el.style.filter = 'drop-shadow(0 0 12px #fbbf24) drop-shadow(0 0 12px #10b981) brightness(1.4)';
      el.style.stroke = '#fbbf24';
      el.style.strokeWidth = '4';
    }
    // VIP only
    else if (booth.isVIP) {
      el.style.filter = 'drop-shadow(0 0 10px #fbbf24) brightness(1.3)';
      el.style.stroke = '#fbbf24';
      el.style.strokeWidth = '3';
    }
    // O2O only
    else if (booth.isO2O) {
      el.style.filter = 'drop-shadow(0 0 8px #10b981) brightness(1.2)';
      el.style.stroke = '#10b981';
      el.style.strokeWidth = '2';
    }
    
    // Selected booth
    if (selectedBooth && id === selectedBooth.id) {
      el.style.filter = 'drop-shadow(0 0 15px #f59e0b) brightness(1.5)';
      el.style.stroke = '#f59e0b';
      el.style.strokeWidth = '5';
    }
  });
  
  document.getElementById('stats').textContent = `${visible} of ${Object.keys(boothMap).length} visible`;
}

function debounceFilter() {
  clearTimeout(filterTimeout);
  filterTimeout = setTimeout(applyFilters, 300);
}

// Select booth
function selectBooth(id, booth) {
  selectedBooth = {id, ...booth};
  
  const panel = document.getElementById('info-panel');
  const title = document.getElementById('info-title');
  const content = document.getElementById('info-content');
  
  panel.classList.remove('hidden');
  title.textContent = booth['Company name'] || 'Booth ' + id;
  
  let html = '<div class="space-y-3 text-sm">';
  
  // Badges
  if (booth.isVIP || booth.isO2O) {
    html += '<div class="flex gap-2 mb-3">';
    if (booth.isVIP && booth.isO2O) {
      html += '<span class="badge-both">‚≠êüîó VIP+O2O</span>';
    } else {
      if (booth.isVIP) html += '<span class="badge-vip">‚≠ê VIP</span>';
      if (booth.isO2O) html += '<span class="badge-o2o">üîó O2O</span>';
    }
    html += '</div>';
  }
  
  html += `<div class="py-2 border-b font-semibold">üìç Booth: ${booth['Stand_no']}</div>`;
  
  // Products (Column H) - HIGHLIGHTED
  if (booth['Exhibited products']) {
    html += `<div class="info-highlight">
      <div class="font-bold text-blue-900 mb-2">üè∑Ô∏è Exhibited Products:</div>
      <div class="text-blue-800">${booth['Exhibited products']}</div>
    </div>`;
  }
  
  // Categories - HIGHLIGHTED
  if (booth['T1']) {
    html += `<div class="info-highlight">
      <div class="font-bold text-blue-900">üìÇ Category (T1):</div>
      <div class="text-blue-800">${booth['T1']}</div>
    </div>`;
  }
  
  if (booth['T2']) {
    html += `<div class="py-2 border-b"><b>Sub-category (T2):</b> ${booth['T2']}</div>`;
  }
  if (booth['T3']) {
    html += `<div class="py-2 border-b"><b>Product Type (T3):</b> ${booth['T3']}</div>`;
  }
  
  if (booth['International station link']) {
    html += `<a href="${booth['International station link']}" target="_blank" class="block w-full text-center btn btn-primary mt-3">üåê Visit Website</a>`;
  }
  
  html += '</div>';
  content.innerHTML = html;
  
  applyFilters();
}

// Quick search
function quickSearch() {
  const query = document.getElementById('quick-search').value.trim().toUpperCase();
  if (!query) return;
  
  const booth = boothMap[query];
  if (booth) {
    selectBooth(query, booth);
    setStatus(`‚úÖ Found ${query}`);
  } else {
    setStatus(`‚ùå Booth ${query} not found`);
  }
}

// Pan & Zoom
function zoom(factor) {
  const newW = viewBox.w * factor;
  const newH = viewBox.h * factor;
  viewBox.x += (viewBox.w - newW) / 2;
  viewBox.y += (viewBox.h - newH) / 2;
  viewBox.w = newW;
  viewBox.h = newH;
  updateViewBox();
  updateMiniMapViewport();
}

function updateViewBox() {
  if (svgElement) {
    svgElement.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
  }
}

function resetView() {
  if (svgElement) {
    const bbox = svgElement.getBBox();
    viewBox = {x: bbox.x, y: bbox.y, w: bbox.width, h: bbox.height};
    originalViewBox = {...viewBox};
    updateViewBox();
    updateMiniMapViewport();
  }
}

function resetAll() {
  document.getElementById('filter-company').value = '';
  document.getElementById('filter-t1').value = '';
  document.getElementById('filter-t2').value = '';
  document.getElementById('filter-t3').value = '';
  document.getElementById('filter-product').value = '';
  document.getElementById('filter-vip').checked = false;
  document.getElementById('filter-o2o').checked = false;
  document.getElementById('filter-both').checked = false;
  document.getElementById('quick-search').value = '';
  document.getElementById('info-panel').classList.add('hidden');
  selectedBooth = null;
  applyFilters();
  resetView();
}

// Pan
document.getElementById('svg-wrapper').addEventListener('mousedown', (e) => {
  isDragging = true;
  dragStart = {x: e.clientX, y: e.clientY};
});

document.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const dx = (e.clientX - dragStart.x) * (viewBox.w / 800);
  const dy = (e.clientY - dragStart.y) * (viewBox.h / 600);
  viewBox.x -= dx;
  viewBox.y -= dy;
  dragStart = {x: e.clientX, y: e.clientY};
  updateViewBox();
  updateMiniMapViewport();
});

document.addEventListener('mouseup', () => {
  isDragging = false;
});
</script>

</body>
</html>
