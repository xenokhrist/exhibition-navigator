<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exhibition Navigator ‚Äî XLS + VIP/O2O + Products</title>

  <!-- Tailwind CSS (keeps your UI identical) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* --- keep same styles as uploaded file --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    *{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;margin:0}
    .glass{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,0.3)}
    .glass-dark{background:rgba(255,255,255,0.95);backdrop-filter:blur(30px) saturate(200%);-webkit-backdrop-filter:blur(30px) saturate(200%)}
    .spinner{border:3px solid rgba(0,0,0,0.1);border-top:3px solid #374151;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .tooltip{position:fixed;background:rgba(0,0,0,0.92);color:white;padding:10px 14px;border-radius:10px;pointer-events:none;display:none;z-index:1000;max-width:320px}
    .booth-highlighted{filter:drop-shadow(0 0 14px #06b6d4) brightness(1.2) !important;stroke:#06b6d4 !important;stroke-width:8px !important;opacity:1 !important;fill:rgba(34,211,238,0.2) !important}
    .booth-selected{filter:drop-shadow(0 0 28px #f59e0b) brightness(1.4) !important;stroke:#f59e0b !important;stroke-width:12px !important;animation:pulse 1.5s infinite;opacity:1 !important;fill:rgba(251,191,36,0.35) !important}
    .booth-vip{filter:drop-shadow(0 0 20px #f59e0b) !important;stroke:#f59e0b !important}
    .booth-o2o{filter:drop-shadow(0 0 14px #16a34a) !important;stroke:#16a34a !important}
    .booth-dimmed{opacity:.08 !important;pointer-events:none}
    .booth-unmatched{opacity:.18 !important}
    @keyframes pulse{0%,100%{filter:drop-shadow(0 0 28px #f59e0b)}50%{filter:drop-shadow(0 0 44px #f59e0b)}}
    #svg-wrapper svg{cursor:grab;transition:opacity .3s ease}
    #svg-wrapper svg:active{cursor:grabbing}
    .input-apple{width:100%;padding:11px 14px;border-radius:10px;background:rgba(255,255,255,0.9);border:1.5px solid rgba(0,0,0,0.08)}
    .file-label{display:inline-block;padding:10px 18px;background:white;border-radius:10px}
    .zoom-controls{position:absolute;top:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:10}
    .zoom-btn{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,0.95);border:none}
    .info-panel{background:white;border-radius:16px;padding:20px;margin-top:20px}
    .section-header{font-size:13px;font-weight:600;color:#86868b;text-transform:uppercase;margin-bottom:12px}
    .footer{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,0.8);backdrop-filter:blur(20px);padding:8px 20px;text-align:center}
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-dark p-8 rounded-3xl shadow-2xl flex flex-col items-center">
      <div class="spinner"></div>
      <p id="loading-text" class="mt-5 text-gray-700 font-medium">Loading...</p>
    </div>
  </div>

  <header class="glass-dark shadow-lg">
    <div class="max-w-screen-2xl mx-auto px-6 py-5 flex flex-wrap justify-between items-center gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">üó∫Ô∏è Super Sector - Exhibition Navigator - China Homelife Nov 2025</h1>
        <div id="status" class="mt-2">
          <span class="status-badge status-info">
            <span class="inline-block w-2 h-2 bg-blue-500 rounded-full"></span>
            Ready to begin
          </span>
        </div>
      </div>

      <div class="flex gap-3 flex-wrap items-center">
        <label class="file-label">
          <span>üìÑ Choose SVG</span>
          <input id="svg-upload" type="file" accept=".svg" class="file-input" />
        </label>

        <label class="file-label">
          <span>üìä Choose Data (Sellers.xls)</span>
          <input id="excel-upload" type="file" accept=".xlsx,.xls,.csv" class="file-input" />
        </label>
      </div>
    </div>
  </header>

  <main class="flex" style="height: calc(100vh - 180px); margin-top: 1rem;">
    <!-- Sidebar (unchanged UI) -->
    <aside class="w-80 glass ml-4 rounded-2xl shadow-xl overflow-y-auto" style="max-height: calc(100vh - 200px);">
      <div class="p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">üîç Search & Filter</h2>

        <div class="mb-4">
          <label class="section-header">Quick Find Booth</label>
          <input id="quick-search" type="text" class="input-apple" placeholder="e.g., A1B103" />
          <p class="text-xs text-gray-500 mt-2">Press Enter to find and zoom</p>
        </div>

        <div class="mb-4">
          <label class="section-header">Company Name</label>
          <input id="filter-company" type="text" class="input-apple" placeholder="Search company..." />
        </div>

        <div class="mb-4">
          <label class="section-header">Products</label>
          <input id="filter-product" type="text" class="input-apple" placeholder="Search products..." />
        </div>

        <div class="mb-4">
          <label class="section-header">Category (T1)</label>
          <select id="filter-t1" class="input-apple"><option value="">All Categories</option></select>
        </div>

        <div class="mb-4">
          <label class="section-header">Sub-category (T2)</label>
          <select id="filter-t2" class="input-apple"><option value="">All Sub-categories</option></select>
        </div>

        <div class="mb-3">
          <label class="section-header">Badges</label>
          <div style="display:flex;gap:10px;align-items:center">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="filter-vip" /> <span>VIP ‚≠ê</span></label>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="filter-o2o" /> <span>O2O üîó</span></label>
          </div>
        </div>

        <div class="flex gap-3 mb-5">
          <button id="reset-filters" class="btn-apple btn-secondary flex-1">Reset All</button>
          <button id="reset-zoom" class="btn-apple flex-1">Reset View</button>
        </div>

        <div id="info-panel" class="info-panel hidden fade-in">
          <h3 id="info-title" class="text-lg font-semibold text-gray-900 mb-3">Select a booth</h3>
          <div id="info-content"></div>
        </div>

        <div class="stats-card mt-5">
          <p class="section-header mb-2">üìä Statistics</p>
          <p id="stats" class="text-sm font-medium text-gray-700">No data loaded</p>
        </div>
      </div>
    </aside>

    <section id="map-container" class="flex-1 relative mx-4">
      <div class="glass-dark rounded-2xl shadow-xl h-full overflow-hidden relative">
        <div id="svg-wrapper" class="absolute inset-0 flex justify-center items-center">
          <div class="text-center">
            <div class="text-6xl mb-4">üó∫Ô∏è</div>
            <p class="text-gray-600 text-lg font-medium">Upload SVG floor plan to begin</p>
            <p class="text-gray-400 text-sm mt-2">Supports pan, zoom, and interactive booths</p>
          </div>
        </div>

        <div class="zoom-controls hidden" id="zoom-controls">
          <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
          <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
          <button class="zoom-btn" id="zoom-reset" title="Reset View">‚ü≤</button>
        </div>

        <div id="tooltip" class="tooltip"></div>
      </div>
    </section>
  </main>

  <div class="footer">Made with ‚ù§Ô∏è by <a href="#" target="_blank">Firman Khristian</a></div>

  <script>
  /**************************************************************************
   * Enhanced script:
   * - XLS/XLSX parsing (SheetJS)
   * - Booth matching using Stand_no (normalized)
   * - VIP / O2O badges (VIP -> gold glow, O2O -> green glow)
   * - Products shown in info panel (blue highlight)
   * - Pan / zoom (viewBox), pinch support, inertia approximation
   **************************************************************************/

  // DOM refs
  const svgUpload = document.getElementById('svg-upload');
  const excelUpload = document.getElementById('excel-upload');
  const svgWrapper = document.getElementById('svg-wrapper');
  const tooltip = document.getElementById('tooltip');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const statusEl = document.getElementById('status');
  const infoPanel = document.getElementById('info-panel');
  const infoContent = document.getElementById('info-content');
  const statsEl = document.getElementById('stats');

  const quickSearch = document.getElementById('quick-search');
  const filterCompany = document.getElementById('filter-company');
  const filterProduct = document.getElementById('filter-product');
  const filterT1 = document.getElementById('filter-t1');
  const filterT2 = document.getElementById('filter-t2');
  const resetFiltersBtn = document.getElementById('reset-filters');
  const resetZoomBtn = document.getElementById('reset-zoom');
  const zoomControls = document.getElementById('zoom-controls');
  const zoomInBtn = document.getElementById('zoom-in');
  const zoomOutBtn = document.getElementById('zoom-out');
  const zoomResetBtn = document.getElementById('zoom-reset');
  const filterVIPCheckbox = document.getElementById('filter-vip');
  const filterO2OCheckbox = document.getElementById('filter-o2o');

  // state
  let svgElement = null;
  const boothElements = new Map(); // map boothId -> element
  let exhibitors = []; // array of processed exhibitor objects
  const exhibitorsByBooth = new Map(); // boothId -> exhibitor

  // viewBox state
  let viewBox = { x:0, y:0, width:1000, height:1000 };
  let isPanning = false, startPoint = { x:0, y:0 };
  let lastTouchDist = null, lastTouchMid = null;
  // inertia
  let velocity = { x:0, y:0 }, inertiaFrame = null, friction = 0.92, velThreshold = 5;

  // utilities
  function setStatus(msg, type='info'){
    const dot = type==='success' ? 'bg-emerald-600' : (type==='warning' ? 'bg-amber-600' : 'bg-gray-600');
    statusEl.innerHTML = `<span class="status-badge status-info"><span class="inline-block w-2 h-2 ${dot} rounded-full"></span> ${msg}</span>`;
    console.log('[status]', msg);
  }
  function showLoading(msg='Loading...'){ loadingText.textContent = msg; loadingOverlay.classList.remove('hidden'); }
  function hideLoading(){ loadingOverlay.classList.add('hidden'); }
  function debounce(fn, t=250){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a), t); } }
  function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&\"'<>]/g, c=>({'&':'&amp;','\"':'&quot;',\"'\":\"&#39;\",'<':'&lt;','>':'&gt;'}[c])); }

  // ========= viewBox helpers =========
  function updateViewBox(){ if(!svgElement) return; svgElement.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`); }
  function resetViewToSVG(){ if(!svgElement) return; const bbox = svgElement.getBBox(); viewBox = { x: bbox.x, y: bbox.y, width: bbox.width, height: bbox.height }; updateViewBox(); }

  function distance(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

  // ========= pan / zoom (wheel + pinch + inertia) =========
  function startPan(e){ if(e.button!==undefined && e.button!==0) return; isPanning = true; startPoint = { x: e.clientX, y: e.clientY }; svgElement.style.cursor = 'grabbing'; velocity = {x:0,y:0}; if(inertiaFrame){ cancelAnimationFrame(inertiaFrame); inertiaFrame = null; } }
  function doPan(e){ if(!isPanning) return; const dx = e.clientX - startPoint.x; const dy = e.clientY - startPoint.y; const rect = svgElement.getBoundingClientRect(); const sx = viewBox.width / rect.width; const sy = viewBox.height / rect.height; viewBox.x -= dx * sx; viewBox.y -= dy * sy; startPoint = { x: e.clientX, y: e.clientY }; velocity.x = dx * 60; velocity.y = dy * 60; updateViewBox(); }
  function endPan(e){ if(!isPanning) return; isPanning = false; svgElement.style.cursor = 'grab'; // inertia\n    const step = ()=>{\n      const rect = svgElement.getBoundingClientRect();\n      viewBox.x -= (velocity.x / 60) * (viewBox.width / rect.width);\n      viewBox.y -= (velocity.y / 60) * (viewBox.height / rect.height);\n      velocity.x *= friction; velocity.y *= friction; updateViewBox();\n      if(Math.abs(velocity.x) > velThreshold || Math.abs(velocity.y) > velThreshold){ inertiaFrame = requestAnimationFrame(step); } else { inertiaFrame = null; }\n    };\n    inertiaFrame = requestAnimationFrame(step);\n  }

  function handleWheel(e){ e.preventDefault(); if(!svgElement) return; const delta = e.deltaY > 0 ? 1.08 : 1/1.08; const rect = svgElement.getBoundingClientRect(); const mx = e.clientX - rect.left; const my = e.clientY - rect.top; const svgX = viewBox.x + (mx / rect.width) * viewBox.width; const svgY = viewBox.y + (my / rect.height) * viewBox.height; const newW = viewBox.width * delta; const newH = viewBox.height * delta; viewBox.x = svgX - (mx / rect.width) * newW; viewBox.y = svgY - (my / rect.height) * newH; viewBox.width = newW; viewBox.height = newH; updateViewBox(); }

  // touch pinch
  function handleTouchStart(e){ if(!svgElement) return; if(e.touches.length === 1){ isPanning = true; startPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } else if(e.touches.length === 2){ isPanning = false; lastTouchDist = distance({x:e.touches[0].clientX,y:e.touches[0].clientY},{x:e.touches[1].clientX,y:e.touches[1].clientY}); lastTouchMid = { x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 }; } }

  function handleTouchMove(e){ if(!svgElement) return; if(e.touches.length === 1 && isPanning){ e.preventDefault(); const dx = e.touches[0].clientX - startPoint.x; const dy = e.touches[0].clientY - startPoint.y; const rect = svgElement.getBoundingClientRect(); const sx = viewBox.width / rect.width; const sy = viewBox.height / rect.height; viewBox.x -= dx * sx; viewBox.y -= dy * sy; startPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY }; updateViewBox(); } else if(e.touches.length === 2){ e.preventDefault(); const d = distance({x:e.touches[0].clientX,y:e.touches[0].clientY},{x:e.touches[1].clientX,y:e.touches[1].clientY}); const mid = { x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 }; if(lastTouchDist){ const factor = d / lastTouchDist; const rect = svgElement.getBoundingClientRect(); const mx = mid.x - rect.left; const my = mid.y - rect.top; const svgX = viewBox.x + (mx / rect.width) * viewBox.width; const svgY = viewBox.y + (my / rect.height) * viewBox.height; const newW = viewBox.width / factor; const newH = viewBox.height / factor; viewBox.x = svgX - (mx / rect.width) * newW; viewBox.y = svgY - (my / rect.height) * newH; viewBox.width = newW; viewBox.height = newH; updateViewBox(); } lastTouchDist = d; lastTouchMid = mid; } }

  // ========= load SVG and cache booth elements =========
  svgUpload.addEventListener('change', async (ev) => {
    const f = ev.target.files[0]; if(!f) return;
    showLoading('Loading map...'); setStatus('Loading SVG');
    try{
      const text = await f.text();
      svgWrapper.innerHTML = text;
      svgElement = svgWrapper.querySelector('svg');
      if(!svgElement) throw new Error('no <svg> found in file');
      svgElement.style.width = '100%'; svgElement.style.height = '100%'; svgElement.style.cursor = 'grab';
      attachMapEvents();
      cacheBoothElements();
      setStatus('SVG loaded', 'success');
      zoomControls.classList.remove('hidden');
    }catch(err){
      console.error(err); setStatus('Error loading SVG: ' + (err.message || err), 'warning');
    } finally { hideLoading(); }
  });

  function attachMapEvents(){
    if(!svgElement) return;
    svgElement.addEventListener('wheel', handleWheel, { passive: false });
    svgElement.addEventListener('mousedown', startPan);
    window.addEventListener('mousemove', doPan);
    window.addEventListener('mouseup', endPan);
    svgElement.addEventListener('touchstart', handleTouchStart, { passive: false });
    svgElement.addEventListener('touchmove', handleTouchMove, { passive: false });
    svgElement.addEventListener('touchend', () => { isPanning = false; lastTouchDist = null; });
    zoomInBtn.addEventListener('click', ()=>{ zoomBy(1/1.2); });
    zoomOutBtn.addEventListener('click', ()=>{ zoomBy(1.2); });
    zoomResetBtn.addEventListener('click', ()=>{ resetViewToSVG(); });
  }

  function zoomBy(factor){
    if(!svgElement) return;
    const rect = svgElement.getBoundingClientRect();
    const cx = rect.width/2, cy = rect.height/2;
    const svgX = viewBox.x + (cx/rect.width) * viewBox.width;
    const svgY = viewBox.y + (cy/rect.height) * viewBox.height;
    const newW = viewBox.width * factor; const newH = viewBox.height * factor;
    viewBox.x = svgX - (cx/rect.width) * newW; viewBox.y = svgY - (cy/rect.height) * newH; viewBox.width = newW; viewBox.height = newH; updateViewBox();
  }

  function cacheBoothElements(){
    boothElements.clear();
    if(!svgElement) return;
    const els = svgElement.querySelectorAll('[id]');
    els.forEach(el => {
      const id = String(el.id || '').trim().toUpperCase();
      if(id) boothElements.set(id, el);
    });
    // try to infer by text nodes (e.g., booth labels)
    const texts = svgElement.querySelectorAll('text,tspan');
    texts.forEach(t => {
      const txt = (t.textContent || '').trim();
      if(!txt) return;
      const clean = txt.replace(/\s|-|_/g, '').toUpperCase();
      if(clean.length >= 2 && clean.length <= 10 && /[A-Z0-9]/.test(clean) && !boothElements.has(clean)){
        // climb to a parent g or shape
        let p = t.parentElement;
        while(p && p !== svgElement){
          const tag = p.tagName.toLowerCase();
          if(['g','path','rect','polygon','ellipse','circle'].includes(tag)){
            boothElements.set(clean, p);
            break;
          }
          p = p.parentElement;
        }
      }
    });
    console.log('cached booth elements:', boothElements.size);
  }

  // ========= XLS/XLSX handling =========
  excelUpload.addEventListener('change', async (ev) => {
    const f = ev.target.files[0]; if(!f) return;
    showLoading('Reading exhibitor file...');
    setStatus('Reading exhibitor file');
    try{
      // support CSV via PapaParse, otherwise use SheetJS for xls/xlsx
      if(f.name.toLowerCase().endsWith('.csv')){
        const text = await f.text();
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        processExhibitorData(parsed.data);
      } else {
        const ab = await f.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
        processExhibitorData(json);
      }
      setStatus('Data loaded: ' + exhibitors.length + ' rows', 'success');
    }catch(err){
      console.error(err); setStatus('Error reading data: ' + (err.message||err), 'warning');
    } finally { hideLoading(); }
  });

  function normalizeBoothId(v){ if(v===undefined || v===null) return ''; return String(v).replace(/\s|-|_/g, '').toUpperCase(); }

  function truthyVal(v){
    if(v === true || v === 1) return true;
    const s = String(v).trim().toLowerCase();
    return s === '1' || s === 'yes' || s === 'true' || s === 'y';
  }

  function processExhibitorData(rows){
    // Determine likely column names by common fields
    exhibitors = rows.map(r=>{
      // try common column names; this keeps it robust to slightly different headers
      const boothRaw = r['Stand_no'] ?? r['Stand No'] ?? r['Stand_no'] ?? r['Stand'] ?? r['Stand No.'] ?? r['StandNo'] ?? r['stand_no'] ?? r['StandNo.'] ?? r['number of booth'] ?? r['Booth'];
      const productsRaw = r['Exhibited Products'] ?? r['Products'] ?? r['Exhibited Product'] ?? r['‰∫ßÂìÅ'] ?? r['Exhibited Products '];
      const t1 = r['T1'] ?? r['T1 '] ?? r['Category'] ?? r['Â±ïÂå∫'] ?? '';
      const t2 = r['T2'] ?? r['T2 '] ?? r['Subcategory'] ?? r['‰∏ìÂå∫'] ?? '';
      const vipVal = r['VIP'] ?? r['vip'] ?? r['VIP '] ?? r['T'] ?? r['VIP?'] ?? r['VIP_flag'];
      const o2oVal = r['O2O'] ?? r['o2o'] ?? r['O2O '] ?? r['ÊòØÂê¶O2O'] ?? r['O2O_flag'];

      return {
        raw: r,
        id: r['Exhibitor Contract ID'] ?? r['ID'] ?? r['No'] ?? '',
        name: r['Company name'] ?? r['Company Name'] ?? r['ÂÖ¨Âè∏ÂêçÁß∞'] ?? r['Exhibitor Name'] ?? r['Company'] ?? '',
        booth: normalizeBoothId(boothRaw),
        products: productsRaw ?? '',
        t1: t1 ?? '',
        t2: t2 ?? '',
        vip: truthyVal(vipVal),
        o2o: truthyVal(o2oVal)
      };
    });

    exhibitorsByBooth.clear();
    exhibitors.forEach(ex => {
      if(ex.booth) exhibitorsByBooth.set(ex.booth, ex);
    });

    populateFilters();
    renderStats();
    renderInfoPanelEmpty();
    bindBooths(); // apply classes/handlers
  }

  // ========= UI: filters, search, visuals =========
  function populateFilters(){
    const t1 = new Set(), t2 = new Set();
    exhibitors.forEach(e => { if(e.t1) t1.add(e.t1); if(e.t2) t2.add(e.t2); });
    filterT1.innerHTML = '<option value="">All Categories</option>' + Array.from(t1).map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
    filterT2.innerHTML = '<option value="">All Sub-categories</option>' + Array.from(t2).map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');
  }

  function renderStats(){ statsEl.textContent = `${exhibitors.length} exhibitors loaded ‚Ä¢ ${exhibitorsByBooth.size} matched to booths`; }

  function renderInfoPanelEmpty(){ infoPanel.classList.add('hidden'); infoContent.innerHTML = ''; }

  function bindBooths(){
    if(!svgElement) return;
    // clear previous handlers & classes
    boothElements.forEach((el, id) => {
      el.classList.remove('booth-highlighted','booth-selected','booth-dimmed','booth-unmatched','booth-vip','booth-o2o');
      el.removeEventListener('mouseenter', onBoothEnter);
      el.removeEventListener('mouseleave', onBoothLeave);
      el.removeEventListener('click', onBoothClick);
    });

    // attach
    boothElements.forEach((el, id) => {
      el.addEventListener('mouseenter', onBoothEnter);
      el.addEventListener('mouseleave', onBoothLeave);
      el.addEventListener('click', onBoothClick);
      el.addEventListener('pointerdown', ev => ev.stopPropagation());
    });

    // apply VIP/O2O classes from data
    boothElements.forEach((el, id) => {
      const ex = exhibitorsByBooth.get(id);
      if(ex){
        if(ex.vip) el.classList.add('booth-vip');
        if(ex.o2o) el.classList.add('booth-o2o');
      }
    });

    updateVisuals();
  }

  function onBoothEnter(ev){
    const el = ev.currentTarget;
    const id = (el.id||'').toUpperCase();
    const ex = exhibitorsByBooth.get(id);
    if(ex){
      tooltip.style.display = 'block';
      tooltip.textContent = `${ex.name} ‚Ä¢ ${ex.booth}`;
      const r = el.getBoundingClientRect();
      tooltip.style.left = (r.left + r.width/2) + 'px';
      tooltip.style.top = (r.top - 10) + 'px';
    }
  }
  function onBoothLeave(){ tooltip.style.display = 'none'; }
  function onBoothClick(ev){
    const el = ev.currentTarget;
    const id = (el.id||'').toUpperCase();
    selectBoothById(id);
  }

  function selectBoothById(id){
    if(!id) return;
    const ex = exhibitorsByBooth.get(id);
    if(!ex) return;
    // deselect others
    boothElements.forEach((el) => el.classList.remove('booth-selected'));
    const el = boothElements.get(id);
    if(el) el.classList.add('booth-selected');

    // show info
    infoPanel.classList.remove('hidden');
    infoContent.innerHTML = `
      <div class="info-row"><div class="info-label">Company</div><div class="info-value">${escapeHtml(ex.name)}</div></div>
      <div class="info-row"><div class="info-label">Booth</div><div class="info-value">${escapeHtml(ex.booth)}</div></div>
      <div class="info-row"><div class="info-label">Products</div><div class="info-value" style="color:#0369a1">${escapeHtml(ex.products)}</div></div>
      <div class="info-row"><div class="info-label">Category</div><div class="info-value">${escapeHtml(ex.t1)} / ${escapeHtml(ex.t2)}</div></div>
      <div class="info-row"><div class="info-label">VIP</div><div class="info-value">${ex.vip ? '‚≠ê Yes' : '-'}</div></div>
      <div class="info-row"><div class="info-label">O2O</div><div class="info-value">${ex.o2o ? 'üîó Yes' : '-'}</div></div>
    `;

    // center on booth
    if(el && svgElement){
      const rect = el.getBoundingClientRect();
      const containerRect = svgElement.getBoundingClientRect();
      const cx = rect.left + rect.width/2 - containerRect.left;
      const cy = rect.top + rect.height/2 - containerRect.top;
      const svgX = viewBox.x + (cx / containerRect.width) * viewBox.width;
      const svgY = viewBox.y + (cy / containerRect.height) * viewBox.height;
      viewBox.x = svgX - viewBox.width/2;
      viewBox.y = svgY - viewBox.height/2;
      updateViewBox();
    }
  }

  // filters & search
  quickSearch.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      const v = normalizeBoothId(quickSearch.value);
      if(exhibitorsByBooth.has(v)) selectBoothById(v);
    }
  });

  filterCompany.addEventListener('input', debounce(()=>updateVisuals(), 300));
  filterProduct.addEventListener('input', debounce(()=>updateVisuals(), 300));
  filterT1.addEventListener('change', ()=>updateVisuals());
  filterT2.addEventListener('change', ()=>updateVisuals());
  filterVIPCheckbox.addEventListener('change', ()=>updateVisuals());
  filterO2OCheckbox.addEventListener('change', ()=>updateVisuals());

  function updateVisuals(){
    if(!svgElement) return;
    const companyQ = (filterCompany.value || '').trim().toLowerCase();
    const productQ = (filterProduct.value || '').trim().toLowerCase();
    const t1Q = filterT1.value;
    const t2Q = filterT2.value;
    const vipOnly = filterVIPCheckbox.checked;
    const o2oOnly = filterO2OCheckbox.checked;

    boothElements.forEach((el, id) => {
      const ex = exhibitorsByBooth.get(id);
      el.classList.remove('booth-highlighted','booth-dimmed','booth-unmatched');
      if(!ex){ el.classList.add('booth-unmatched'); return; }
      if(vipOnly && !ex.vip){ el.classList.add('booth-dimmed'); return; }
      if(o2oOnly && !ex.o2o){ el.classList.add('booth-dimmed'); return; }
      if(t1Q && ex.t1 !== t1Q){ el.classList.add('booth-dimmed'); return; }
      if(t2Q && ex.t2 !== t2Q){ el.classList.add('booth-dimmed'); return; }
      if(companyQ && !( (ex.name || '').toLowerCase().includes(companyQ) )){ el.classList.add('booth-dimmed'); return; }
      if(productQ && !( (ex.products || '').toLowerCase().includes(productQ) )){ el.classList.add('booth-dimmed'); return; }
      el.classList.add('booth-highlighted');
    });
  }

  // reset buttons
  resetFiltersBtn.addEventListener('click', ()=>{ filterCompany.value=''; filterProduct.value=''; filterT1.value=''; filterT2.value=''; filterVIPCheckbox.checked=false; filterO2OCheckbox.checked=false; updateVisuals(); });
  resetZoomBtn.addEventListener('click', ()=>resetViewToSVG());

  // click outside hides info
  document.addEventListener('click', (e)=>{ if(!e.target.closest('aside') && !e.target.closest('#svg-wrapper')) infoPanel.classList.add('hidden'); });

  // Try auto-load /map.svg and Sellers.xls if served (dev only)
  (async function tryAutoLoad(){
    try {
      const m = await fetch('/map.svg'); if(m.ok){ const t = await m.text(); svgWrapper.innerHTML = t; svgElement = svgWrapper.querySelector('svg'); attachMapEvents(); cacheBoothElements(); zoomControls.classList.remove('hidden'); }
    } catch(e) {}
  })();

  </script>
</body>
</html>
