<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exhibition Navigator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { margin: 0; font-family: system-ui; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
  .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); }
  .badge-vip { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  .badge-o2o { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  .badge-both { background: linear-gradient(135deg, #fbbf24 0%, #10b981 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  .badge-vip-pro { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
  #svg-wrapper svg { cursor: grab; max-width: 100%; max-height: 100%; }
  #svg-wrapper svg:active { cursor: grabbing; }
  .info-highlight { background: #dbeafe; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 8px 0; }
  .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
  .btn-primary { background: #1f2937; color: white; }
  .btn-primary:hover { background: #374151; }
  
  /* Top Exhibitor Card */
  .top-exhibitor-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid transparent;
  }
  .top-exhibitor-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .top-exhibitor-card.rank-1 { border-left-color: #fbbf24; }
  .top-exhibitor-card.rank-2 { border-left-color: #10b981; }
  .top-exhibitor-card.rank-3 { border-left-color: #3b82f6; }
  
  .tooltip {
    position: fixed;
    background: rgba(0, 0, 0, 0.92);
    color: white;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 13px;
    pointer-events: none;
    z-index: 1000;
    display: none;
    max-width: 320px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .minimap {
    position: absolute;
    bottom: 80px;
    left: 20px;
    width: 200px;
    height: 150px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: none;
  }
  .minimap svg {
    width: 100%;
    height: 100%;
  }
  .minimap-viewport {
    fill: rgba(59, 130, 246, 0.3);
    stroke: #3b82f6;
    stroke-width: 2;
    pointer-events: none;
  }
  
  .footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    padding: 8px 20px;
    text-align: center;
    font-size: 12px;
    color: #6b7280;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    z-index: 50;
  }
  
  .footer a {
    color: #374151;
    text-decoration: none;
    font-weight: 600;
  }
</style>
</head>
<body>

<header class="glass p-4 shadow-lg">
  <div class="flex justify-between items-center max-w-screen-2xl mx-auto">
    <div>
      <h1 class="text-2xl font-bold">üó∫Ô∏è Super Sector - Exhibition Navigator for China Homelife 2025</h1>
      <p id="status" class="text-sm text-gray-600 mt-1">Upload files to begin</p>
    </div>
    <div class="flex gap-3">
      <button onclick="clearMap()" class="btn btn-primary bg-red-600 hover:bg-red-700">üóëÔ∏è Clear</button>
      <button onclick="document.getElementById('svg-upload').click()" class="btn btn-primary">üìÑ SVG</button>
      <button onclick="document.getElementById('data-upload').click()" class="btn btn-primary">üìä Data</button>
      <input id="svg-upload" type="file" accept=".svg" style="display:none" onchange="handleSVGUpload(event)">
      <input id="data-upload" type="file" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleDataUpload(event)">
    </div>
  </div>
</header>

<div class="flex h-screen">
  <aside class="w-80 glass p-4 overflow-y-auto">
    <h2 class="text-lg font-semibold mb-4">üîç Search & Filter</h2>
    
    <div class="mb-4">
      <label class="text-sm font-medium">Quick Find Booth</label>
      <input id="quick-search" type="text" placeholder="e.g., A3C101" class="w-full mt-2 px-3 py-2 border rounded-lg" onkeypress="if(event.key==='Enter') quickSearch()">
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Type</label>
      <div class="mt-2 space-y-2">
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-vip" type="checkbox" onchange="applyFilters()">
          <span class="badge-vip">‚≠ê VIP</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-o2o" type="checkbox" onchange="applyFilters()">
          <span class="badge-o2o">üîó O2O</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="filter-both" type="checkbox" onchange="applyFilters()">
          <span class="badge-both">‚≠êüîó VIP+O2O</span>
        </label>
      </div>
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Company</label>
      <input id="filter-company" type="text" placeholder="Search..." class="w-full mt-2 px-3 py-2 border rounded-lg" oninput="debounceFilter()">
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Category (T1)</label>
      <select id="filter-t1" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Sub-category (T2)</label>
      <select id="filter-t2" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Product Type (T3)</label>
      <select id="filter-t3" class="w-full mt-2 px-3 py-2 border rounded-lg" onchange="applyFilters()">
        <option value="">All</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="text-sm font-medium">Products</label>
      <input id="filter-product" type="text" placeholder="Search products..." class="w-full mt-2 px-3 py-2 border rounded-lg" oninput="debounceFilter()">
    </div>

    <button onclick="resetAll()" class="w-full btn btn-primary">Reset All</button>

    <div id="info-panel" class="mt-6 p-4 bg-white rounded-lg shadow-lg hidden">
      <h3 id="info-title" class="font-bold text-lg mb-3"></h3>
      <div id="info-content"></div>
    </div>

    <div class="mt-6 p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg border border-blue-200">
      <p class="text-xs font-bold text-blue-800 mb-3 flex items-center gap-2">
        üèÜ TOP 3 EXHIBITORS
      </p>
      <div id="top-exhibitors">
        <p class="text-sm text-gray-500">No data loaded</p>
      </div>
    </div>

    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
      <p class="text-xs font-bold text-blue-800">STATISTICS</p>
      <p id="stats" class="text-sm text-blue-900 mt-1">No data</p>
    </div>
  </aside>

  <main class="flex-1 relative">
    <div id="svg-wrapper" class="w-full h-full"></div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <div id="minimap" class="minimap">
      <svg id="minimap-svg"></svg>
    </div>
    
    <div id="zoom-controls" class="absolute bottom-4 right-4 flex flex-col gap-2" style="display:none">
      <button onclick="zoom(0.8)" class="w-12 h-12 bg-white rounded-lg shadow-lg text-xl font-bold hover:bg-gray-50">+</button>
      <button onclick="zoom(1.2)" class="w-12 h-12 bg-white rounded-lg shadow-lg text-xl font-bold hover:bg-gray-50">‚àí</button>
      <button onclick="resetView()" class="w-12 h-12 bg-white rounded-lg shadow-lg text-lg hover:bg-gray-50">‚ü≤</button>
    </div>

    <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-gray-400">
      <div class="text-center">
        <div class="text-6xl mb-4">üó∫Ô∏è</div>
        <p class="text-lg">Upload SVG and Data files</p>
      </div>
    </div>
  </main>
</div>

<footer class="footer">
  Made with ‚ù§Ô∏è by <a href="#" target="_blank">Firman Khristian</a>
</footer>

<script>
let boothMap = {};
let boothData = [];
let selectedBooth = null;
let svgElement = null;
let viewBox = {x:0, y:0, w:1000, h:1000};
let originalViewBox = {x:0, y:0, w:1000, h:1000};
let isDragging = false;
let dragStart = {x:0, y:0};
let filterTimeout = null;

function setStatus(msg) {
  document.getElementById('status').textContent = msg;
  console.log('[STATUS]', msg);
}

function getTop3Exhibitors() {
  const exhibitors = Object.entries(boothMap).map(([id, booth]) => ({
    id,
    company: booth['Company name'] || 'N/A',
    booth: booth['Stand_no'],
    isVIPPro: booth['VIP-Pro'] == 1,
    isVIP: booth.isVIP,
    isO2O: booth.isO2O,
    ...booth
  }));

  exhibitors.sort((a, b) => {
    if (a.isVIPPro !== b.isVIPPro) return b.isVIPPro - a.isVIPPro;
    if ((a.isVIP && a.isO2O) !== (b.isVIP && b.isO2O)) return (b.isVIP && b.isO2O) - (a.isVIP && a.isO2O);
    if (a.isVIP !== b.isVIP) return b.isVIP - a.isVIP;
    if (a.isO2O !== b.isO2O) return b.isO2O - a.isO2O;
    return 0;
  });

  return exhibitors.slice(0, 3);
}

function updateTop3Display() {
  const container = document.getElementById('top-exhibitors');
  const top3 = getTop3Exhibitors();

  if (top3.length === 0) {
    container.innerHTML = '<p class="text-sm text-gray-500">No exhibitors found</p>';
    return;
  }

  const medals = ['ü•á', 'ü•à', 'ü•â'];
  
  container.innerHTML = top3.map((exhibitor, index) => {
    let badge = '';
    if (exhibitor.isVIPPro) {
      badge = '<span class="badge-vip-pro">üëë VIP-Pro</span>';
    } else if (exhibitor.isVIP && exhibitor.isO2O) {
      badge = '<span class="badge-both">‚≠êüîó VIP+O2O</span>';
    } else if (exhibitor.isVIP) {
      badge = '<span class="badge-vip">‚≠ê VIP</span>';
    } else if (exhibitor.isO2O) {
      badge = '<span class="badge-o2o">üîó O2O</span>';
    }

    return `
      <div class="top-exhibitor-card rank-${index + 1}" onclick="selectBoothFromTop('${exhibitor.id}')">
        <div class="flex items-start gap-2">
          <span class="text-2xl">${medals[index]}</span>
          <div class="flex-1">
            <div class="font-semibold text-sm text-gray-800 mb-1">${exhibitor.company}</div>
            <div class="text-xs text-gray-600 mb-2">üìç Booth: ${exhibitor.booth}</div>
            ${badge ? `<div>${badge}</div>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function selectBoothFromTop(id) {
  const booth = boothMap[id];
  if (booth) {
    selectBooth(id, booth);
  }
}

async function handleSVGUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const wrapper = document.getElementById('svg-wrapper');
    wrapper.innerHTML = '';
    svgElement = null;
    
    document.getElementById('minimap').style.display = 'none';
    document.getElementById('minimap-svg').innerHTML = '';
    
    wrapper.innerHTML = text;
    document.getElementById('placeholder').style.display = 'none';
    
    svgElement = document.querySelector('#svg-wrapper svg');
    if (svgElement) {
      svgElement.style.width = '100%';
      svgElement.style.height = '100%';
      
      const bbox = svgElement.getBBox();
      viewBox = {x: bbox.x, y: bbox.y, w: bbox.width, h: bbox.height};
      originalViewBox = {...viewBox};
      updateViewBox();
      
      createMiniMap();
      
      document.getElementById('zoom-controls').style.display = 'flex';
      setStatus('‚úÖ SVG loaded - ' + file.name);
      
      if (Object.keys(boothMap).length) {
        bindBooths();
      }
    }
  } catch (err) {
    setStatus('‚ùå Error loading SVG: ' + err.message);
    console.error(err);
  }
}

async function handleDataUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    let jsonData;
    
    if (file.name.endsWith('.csv')) {
      const text = await file.text();
      const parsed = Papa.parse(text, {header: true, delimiter: ';', skipEmptyLines: true});
      jsonData = parsed.data;
    } else {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type: 'array'});
      jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    }
    
    boothData = jsonData;
    boothMap = {};
    let vipCount = 0, o2oCount = 0, bothCount = 0, vipProCount = 0;
    
    jsonData.forEach(row => {
      const id = String(row['Stand_no'] || '').trim().toUpperCase();
      if (!id) return;
      
      const isVIPPro = row['VIP-Pro'] == 1 || String(row['VIP-Pro']).toLowerCase() === 'yes';
      const isVIP = row['VIP'] == 1 || String(row['VIP']).toLowerCase() === 'yes';
      const isO2O = row['O2O'] == 1 || String(row['O2O']).toLowerCase() === 'yes';
      
      if (isVIPPro) vipProCount++;
      if (isVIP && isO2O) bothCount++;
      else if (isVIP) vipCount++;
      else if (isO2O) o2oCount++;
      
      boothMap[id] = {...row, isVIPPro, isVIP, isO2O};
    });
    
    const t1 = [...new Set(jsonData.map(r => r['T1']).filter(Boolean))].sort();
    const t2 = [...new Set(jsonData.map(r => r['T2']).filter(Boolean))].sort();
    const t3 = [...new Set(jsonData.map(r => r['T3']).filter(Boolean))].sort();
    
    populateSelect('filter-t1', t1);
    populateSelect('filter-t2', t2);
    populateSelect('filter-t3', t3);
    
    let statsText = `${jsonData.length} exhibitors`;
    if (vipProCount > 0) statsText += ` | ${vipProCount} VIP-Pro`;
    if (bothCount > 0) statsText += ` | ${bothCount} VIP+O2O`;
    if (vipCount > 0) statsText += ` | ${vipCount} VIP`;
    if (o2oCount > 0) statsText += ` | ${o2oCount} O2O`;
    
    document.getElementById('stats').textContent = statsText;
    
    updateTop3Display();
    
    setStatus(`‚úÖ Loaded ${jsonData.length} exhibitors from ${file.name}`);
    
    if (svgElement) bindBooths();
    
  } catch (err) {
    setStatus('‚ùå Error loading data: ' + err.message);
    console.error(err);
  }
}

function populateSelect(id, options) {
  const select = document.getElementById(id);
  select.innerHTML = '<option value="">All</option>' + 
    options.map(o => `<option value="${o}">${o}</option>`).join('');
}

function createMiniMap() {
  const minimapSvg = document.getElementById('minimap-svg');
  const mainSvgClone = svgElement.cloneNode(true);
  
  minimapSvg.innerHTML = mainSvgClone.innerHTML;
  minimapSvg.setAttribute('viewBox', `${originalViewBox.x} ${originalViewBox.y} ${originalViewBox.w} ${originalViewBox.h}`);
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('class', 'minimap-viewport');
  rect.setAttribute('id', 'minimap-viewport-rect');
  minimapSvg.appendChild(rect);
  
  updateMiniMapViewport();
}

function updateMiniMapViewport() {
  const rect = document.getElementById('minimap-viewport-rect');
  if (!rect) return;
  
  const scaleX = originalViewBox.w / viewBox.w;
  const scaleY = originalViewBox.h / viewBox.h;
  
  rect.setAttribute('x', viewBox.x);
  rect.setAttribute('y', viewBox.y);
  rect.setAttribute('width', viewBox.w);
  rect.setAttribute('height', viewBox.h);
  
  const minimap = document.getElementById('minimap');
  if (scaleX > 1.2 || scaleY > 1.2) {
    minimap.style.display = 'block';
  } else {
    minimap.style.display = 'none';
  }
}

function bindBooths() {
  if (!svgElement || !Object.keys(boothMap).length) return;
  
  const elements = svgElement.querySelectorAll('[id], text');
  
  elements.forEach(el => {
    let id = el.id || el.textContent?.trim();
    if (!id) return;
    
    id = id.toUpperCase();
    const booth = boothMap[id];
    
    if (!booth) {
      el.style.opacity = '0.2';
      el.style.filter = 'grayscale(1)';
      return;
    }
    
    el.style.cursor = 'pointer';
    
    el.onmouseenter = (e) => showTooltip(e, booth);
    el.onmousemove = (e) => moveTooltip(e);
    el.onmouseleave = () => hideTooltip();
    
    el.onclick = () => selectBooth(id, booth);
  });
  
  applyFilters();
}

function showTooltip(e, booth) {
  const tooltip = document.getElementById('tooltip');
  
  let badges = '';
  if (booth.isVIPPro) {
    badges = '<span class="badge-vip-pro">üëë VIP-Pro</span>';
  } else if (booth.isVIP && booth.isO2O) {
    badges = '<span class="badge-both">‚≠êüîó VIP+O2O</span>';
  } else if (booth.isVIP) {
    badges = '<span class="badge-vip">‚≠ê VIP</span>';
  } else if (booth.isO2O) {
    badges = '<span class="badge-o2o">üîó O2O</span>';
  }
  
  const products = booth['Exhibited products'] || booth['Exhibited Products'] || booth['exhibited products'] || booth['Exhibition products'] || booth['Products'] || booth['‰∫ßÂìÅ'] || '';
  
  const productsHtml = products ? 
    `<div class="text-xs text-green-200 mt-1">üè∑Ô∏è ${products.substring(0, 60)}${products.length > 60 ? '...' : ''}</div>` : '';
  
  tooltip.innerHTML = `
    <div class="font-bold mb-1">${booth['Company name'] || 'N/A'}</div>
    <div class="text-xs text-gray-300 mb-2">üìç Booth: ${booth['Stand_no']}</div>
    ${badges ? `<div class="mb-2">${badges}</div>` : ''}
    ${booth['T1'] ? `<div class="text-xs text-yellow-200">üìÇ ${booth['T1']}</div>` : ''}
    ${productsHtml}
  `;
  
  tooltip.style.display = 'block';
  moveTooltip(e);
}

function moveTooltip(e) {
  const tooltip = document.getElementById('tooltip');
  tooltip.style.left = (e.pageX + 15) + 'px';
  tooltip.style.top = (e.pageY + 15) + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

function applyFilters() {
  if (!svgElement) return;
  
  const filters = {
    company: document.getElementById('filter-company').value.toLowerCase(),
    t1: document.getElementById('filter-t1').value,
    t2: document.getElementById('filter-t2').value,
    t3: document.getElementById('filter-t3').value,
    product: document.getElementById('filter-product').value.toLowerCase(),
    vip: document.getElementById('filter-vip').checked,
    o2o: document.getElementById('filter-o2o').checked,
    both: document.getElementById('filter-both').checked
  };
  
  const elements = svgElement.querySelectorAll('[id], text');
  let visible = 0;
  
  elements.forEach(el => {
    let id = el.id || el.textContent?.trim();
    if (!id) return;
    
    id = id.toUpperCase();
    const booth = boothMap[id];
    
    if (!booth) return;
    
    let match = true;
    
    if (filters.company && !booth['Company name']?.toLowerCase().includes(filters.company)) match = false;
    if (filters.t1 && booth['T1'] !== filters.t1) match = false;
    if (filters.t2 && booth['T2'] !== filters.t2) match = false;
    if (filters.t3 && booth['T3'] !== filters.t3) match = false;
    
    if (filters.product) {
      const exhibitedProducts = booth['Exhibited products'] || booth['Exhibited Products'] || booth['exhibited products'] || booth['Exhibition products'] || booth['Products'] || booth['‰∫ßÂìÅ'] || '';
      if (!exhibitedProducts.toLowerCase().includes(filters.product)) {
        match = false;
      }
    }
    
    if (filters.both && !(booth.isVIP && booth.isO2O)) match = false;
    if (filters.vip && !filters.both && !booth.isVIP) match = false;
    if (filters.o2o && !filters.both && !booth.isO2O) match = false;
    
    if (!match) {
      el.style.opacity = '0.1';
      el.style.filter = 'grayscale(1)';
      return;
    }
    
    visible++;
    el.style.opacity = '1';
    el.style.filter = '';
    
    if (booth.isVIPPro) {
      el.style.filter = 'drop-shadow(0 0 15px #8b5cf6) brightness(1.5)';
      el.style.stroke = '#8b5cf6';
      el.style.strokeWidth = '5';
    } else if (booth.isVIP && booth.isO2O) {
      el.style.filter = 'drop-shadow(0 0 12px #fbbf24) drop-shadow(0 0 12px #10b981) brightness(1.4)';
      el.style.stroke = '#fbbf24';
      el.style.strokeWidth = '4';
    } else if (booth.isVIP) {
      el.style.filter = 'drop-shadow(0 0 10px #fbbf24) brightness(1.3)';
      el.style.stroke = '#fbbf24';
      el.style.strokeWidth = '3';
    } else if (booth.isO2O) {
      el.style.filter = 'drop-shadow(0 0 8px #10b981) brightness(1.2)';
      el.style.stroke = '#10b981';
      el.style.strokeWidth = '2';
    }
    
    if (selectedBooth && id === selectedBooth.id) {
      el.style.filter = 'drop-shadow(0 0 15px #f59e0b) brightness(1.5)';
      el.style.stroke = '#f59e0b';
      el.style.strokeWidth = '5';
    }
  });
  
  document.getElementById('stats').textContent = `${visible} of ${Object.keys(boothMap).length} visible`;
}

function debounceFilter() {
  clearTimeout(filterTimeout
