<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Exhibition Navigator</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .glass-dark {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
    }
    
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid #374151;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in { animation: fadeIn 0.4s ease-out; }
    
    .tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.92);
      color: white;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 13px;
      pointer-events: none;
      z-index: 1000;
      display: none;
      max-width: 340px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Booth badges */
    .booth-vip {
      filter: drop-shadow(0 0 20px #fbbf24) brightness(1.6) !important;
      stroke: #fbbf24 !important;
      stroke-width: 14px !important;
    }
    
    .booth-o2o {
      filter: drop-shadow(0 0 16px #10b981) brightness(1.4) !important;
      stroke: #10b981 !important;
      stroke-width: 10px !important;
    }
    
    .booth-highlighted {
      filter: drop-shadow(0 0 14px #06b6d4) brightness(1.3) !important;
      stroke: #06b6d4 !important;
      stroke-width: 8px !important;
      opacity: 1 !important;
      fill: rgba(34, 211, 238, 0.25) !important;
    }
    
    .booth-selected {
      filter: drop-shadow(0 0 28px #f59e0b) brightness(1.5) !important;
      stroke: #f59e0b !important;
      stroke-width: 12px !important;
      animation: pulse 1.5s ease-in-out infinite;
      opacity: 1 !important;
      fill: rgba(251, 191, 36, 0.35) !important;
    }
    
    .booth-dimmed {
      opacity: 0.06 !important;
      filter: grayscale(1) blur(0.5px);
      pointer-events: none;
    }
    
    .booth-unmatched {
      opacity: 0.18 !important;
      filter: grayscale(1);
    }
    
    @keyframes pulse {
      0%, 100% { 
        filter: drop-shadow(0 0 28px #f59e0b) brightness(1.5);
        stroke-width: 12px;
      }
      50% { 
        filter: drop-shadow(0 0 44px #f59e0b) brightness(1.7);
        stroke-width: 16px;
      }
    }
    
    /* Badge styles */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-vip {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
    }
    
    .badge-o2o {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    #svg-wrapper svg {
      cursor: grab;
      transition: opacity 0.3s ease;
      touch-action: none;
    }
    
    #svg-wrapper svg:active {
      cursor: grabbing;
    }
    
    .input-apple {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: #1d1d1f;
    }
    
    .input-apple:focus {
      outline: none;
      border-color: #374151;
      background: white;
      box-shadow: 0 0 0 4px rgba(55, 65, 81, 0.1);
    }
    
    .input-apple::placeholder {
      color: #86868b;
    }
    
    .btn-apple {
      padding: 11px 20px;
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      touch-action: manipulation;
    }
    
    .btn-apple:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
      background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
    }
    
    .btn-apple:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);
    }
    
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }
    
    .zoom-btn {
      width: 50px;
      height: 50px;
      border: none;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 500;
      color: #1d1d1f;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      touch-action: manipulation;
    }
    
    .zoom-btn:active {
      transform: scale(0.95);
      background: #f0f0f0;
    }
    
    .info-panel {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
      max-height: 450px;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      -webkit-overflow-scrolling: touch;
    }
    
    .info-panel::-webkit-scrollbar {
      width: 6px;
    }
    
    .info-panel::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 10px;
    }
    
    .info-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      transition: background 0.2s ease;
    }
    
    .info-row:hover {
      background: rgba(55, 65, 81, 0.02);
    }
    
    .info-label {
      font-weight: 500;
      color: #86868b;
      min-width: 140px;
      font-size: 14px;
    }
    
    .info-value {
      color: #1d1d1f;
      flex: 1;
      font-size: 14px;
      word-wrap: break-word;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.15);
      color: #047857;
    }
    
    .status-warning {
      background: rgba(245, 158, 11, 0.15);
      color: #b45309;
    }
    
    .status-info {
      background: rgba(55, 65, 81, 0.15);
      color: #374151;
    }
    
    .stats-card {
      background: linear-gradient(135deg, rgba(55, 65, 81, 0.08) 0%, rgba(17, 24, 39, 0.08) 100%);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(55, 65, 81, 0.15);
    }
    
    .section-header {
      font-size: 13px;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .mobile-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(calc(100% - 80px));
      transition: transform 0.3s ease;
      z-index: 100;
      max-height: 85vh;
      display: none;
    }
    
    .mobile-drawer.open {
      transform: translateY(0);
    }
    
    .drawer-handle {
      width: 40px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      margin: 12px auto;
      cursor: pointer;
    }
    
    .drawer-content {
      padding: 0 20px 20px;
      overflow-y: auto;
      max-height: calc(85vh - 60px);
      -webkit-overflow-scrolling: touch;
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      padding: 8px 20px;
      text-align: center;
      font-size: 12px;
      color: #86868b;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      z-index: 50;
    }
    
    .footer a {
      color: #374151;
      text-decoration: none;
      font-weight: 500;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    
    .checkbox-apple {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .desktop-sidebar {
        display: none !important;
      }
      
      .mobile-drawer {
        display: block;
      }
      
      .footer {
        display: none;
      }
      
      .info-label {
        min-width: 100px;
        font-size: 13px;
      }
      
      .info-value {
        font-size: 13px;
      }
      
      .zoom-controls {
        bottom: 100px;
        right: 15px;
      }
      
      .zoom-btn {
        width: 45px;
        height: 45px;
      }
    }
    
    @media (min-width: 769px) {
      .desktop-sidebar {
        display: block !important;
      }
    }
  </style>
</head>

<body>
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-dark p-8 rounded-3xl shadow-2xl flex flex-col items-center">
      <div class="spinner"></div>
      <p class="mt-5 text-gray-700 font-medium" id="loading-text">Loading exhibition data...</p>
      <p class="mt-2 text-sm text-gray-500" id="loading-detail"></p>
    </div>
  </div>

  <header class="glass-dark shadow-lg">
    <div class="max-w-screen-2xl mx-auto px-4 md:px-6 py-4 md:py-5">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-xl md:text-2xl font-semibold text-gray-900">üó∫Ô∏è Exhibition Navigator</h1>
          <div id="status" class="mt-2">
            <span class="status-badge status-info">
              <span class="inline-block w-2 h-2 bg-gray-600 rounded-full"></span>
              Initializing...
            </span>
          </div>
        </div>
        <button id="mobile-menu-btn" class="md:hidden btn-apple px-4 py-2">
          <span class="text-lg">‚ò∞</span>
        </button>
      </div>
    </div>
  </header>

  <main class="flex h-[calc(100vh-100px)] md:h-[calc(100vh-180px)] mt-2 md:mt-4">
    <aside class="desktop-sidebar w-80 glass ml-4 rounded-2xl shadow-xl overflow-y-auto" style="max-height: calc(100vh - 200px);">
      <div class="p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">üîç Search & Filter</h2>
        
        <div class="mb-5">
          <label class="section-header">Quick Find Booth</label>
          <input id="quick-search" type="text" class="input-apple" placeholder="e.g., B2H212" />
          <p class="text-xs text-gray-500 mt-2">Press Enter to find</p>
        </div>
        
        <div class="border-t border-gray-200 my-5"></div>
        
        <!-- Badge Filters -->
        <div class="mb-5">
          <label class="section-header">Exhibitor Type</label>
          <div class="checkbox-container">
            <input type="checkbox" id="filter-vip" class="checkbox-apple" />
            <label for="filter-vip" class="text-sm font-medium cursor-pointer">
              <span class="badge badge-vip">‚≠ê VIP</span>
            </label>
          </div>
          <div class="checkbox-container">
            <input type="checkbox" id="filter-o2o" class="checkbox-apple" />
            <label for="filter-o2o" class="text-sm font-medium cursor-pointer">
              <span class="badge badge-o2o">üîó O2O</span>
            </label>
          </div>
        </div>
        
        <div class="mb-5">
          <label class="section-header">Company Name</label>
          <input id="filter-company" type="text" class="input-apple" placeholder="Search company..." />
        </div>
        
        <div class="mb-5">
          <label class="section-header">Category (T1)</label>
          <select id="filter-t1" class="input-apple">
            <option value="">All Categories</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="section-header">Sub-category (T2)</label>
          <select id="filter-t2" class="input-apple">
            <option value="">All Sub-categories</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="section-header">Product Type (T3)</label>
          <select id="filter-t3" class="input-apple">
            <option value="">All Product Types</option>
          </select>
        </div>
        
        <div class="mb-5">
          <label class="section-header">Products</label>
          <input id="filter-product" type="text" class="input-apple" placeholder="Search products..." />
        </div>
        
        <div class="flex gap-3 mb-5">
          <button id="reset-filters" class="btn-apple btn-secondary flex-1">Reset All</button>
          <button id="reset-zoom" class="btn-apple flex-1">Reset View</button>
        </div>
        
        <div id="info-panel" class="info-panel hidden fade-in">
          <h3 id="info-title" class="text-lg font-semibold text-gray-900 mb-3">Select a booth</h3>
          <div id="info-content"></div>
        </div>
        
        <div class="stats-card mt-5">
          <p class="section-header mb-2">üìä Statistics</p>
          <p id="stats" class="text-sm font-medium text-gray-700">Loading...</p>
        </div>
      </div>
    </aside>

    <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-handle" id="drawer-handle"></div>
      <div class="drawer-content">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">üîç Search & Filter</h2>
        
        <div class="mb-4">
          <label class="section-header">Quick Find</label>
          <input id="quick-search-mobile" type="text" class="input-apple" placeholder="Booth ID" />
        </div>
        
        <div class="mb-4">
          <label class="section-header">Type</label>
          <div class="checkbox-container">
            <input type="checkbox" id="filter-vip-mobile" class="checkbox-apple" />
            <label for="filter-vip-mobile"><span class="badge badge-vip">‚≠ê VIP</span></label>
          </div>
          <div class="checkbox-container">
            <input type="checkbox" id="filter-o2o-mobile" class="checkbox-apple" />
            <label for="filter-o2o-mobile"><span class="badge badge-o2o">üîó O2O</span></label>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="section-header">Company</label>
          <input id="filter-company-mobile" type="text" class="input-apple" placeholder="Search..." />
        </div>
        
        <div class="mb-4">
          <label class="section-header">Category</label>
          <select id="filter-t1-mobile" class="input-apple">
            <option value="">All</option>
          </select>
        </div>
        
        <div class="flex gap-3 mb-4">
          <button id="reset-filters-mobile" class="btn-apple btn-secondary flex-1">Reset</button>
          <button id="reset-zoom-mobile" class="btn-apple flex-1">Reset View</button>
        </div>
        
        <div id="info-panel-mobile" class="info-panel hidden">
          <h3 id="info-title-mobile" class="text-lg font-semibold text-gray-900 mb-3">Booth Info</h3>
          <div id="info-content-mobile"></div>
        </div>
        
        <div class="stats-card mt-4 mb-20">
          <p class="section-header mb-2">üìä Stats</p>
          <p id="stats-mobile" class="text-sm font-medium text-gray-700">Loading...</p>
        </div>
      </div>
    </div>

    <section id="map-container" class="flex-1 relative mx-2 md:mx-4">
      <div class="glass-dark rounded-2xl shadow-xl h-full overflow-hidden relative">
        <div id="svg-wrapper" class="absolute inset-0 flex justify-center items-center">
          <div class="text-center px-4">
            <div class="text-4xl md:text-6xl mb-4">üó∫Ô∏è</div>
            <p class="text-gray-600 text-base md:text-lg font-medium">Loading map...</p>
          </div>
        </div>
        
        <div class="zoom-controls hidden" id="zoom-controls">
          <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
          <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
          <button class="zoom-btn" id="zoom-reset" title="Reset" style="font-size: 18px;">‚ü≤</button>
        </div>
        
        <div id="tooltip" class="tooltip"></div>
      </div>
    </section>
  </main>

  <div class="footer">
    Made with ‚ù§Ô∏è by <strong>Your Team</strong> | Powered by Claude AI
  </div>

  <script>
    console.log('üöÄ Exhibition Navigator v2.1');
    
    // ==================== CONFIG ====================
    const CONFIG = {
      // Try multiple possible filenames
      svgFiles: ['map.svg', 'Nov_IDN_clean.svg', 'floorplan.svg'],
      dataFiles: ['data.csv', 'sellers.csv', 'Sellers.xlsx', 'seller_sample.csv'],
      autoLoad: true
    };
    
    // ==================== STATE ====================
    let svgElement = null;
    let boothData = [];
    let boothMap = {};
    let boothElements = new Map();
    let selectedBoothId = null;
    let filterTimeout = null;
    let isMobile = window.innerWidth <= 768;
    
    let viewBox = { x: 0, y: 0, width: 1000, height: 1000 };
    let isPanning = false;
    let startPoint = { x: 0, y: 0 };
    let touchStartDistance = 0;

    const tooltip = document.getElementById("tooltip");
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingText = document.getElementById("loading-text");
    const loadingDetail = document.getElementById("loading-detail");
    const statusEl = document.getElementById("status");
    const mobileDrawer = document.getElementById("mobile-drawer");
    const drawerHandle = document.getElementById("drawer-handle");

    function setStatus(msg, type = "info") {
      const badges = {
        success: { class: "status-success", dot: "bg-emerald-600" },
        warning: { class: "status-warning", dot: "bg-amber-600" },
        info: { class: "status-info", dot: "bg-gray-600" }
      };
      const badge = badges[type];
      statusEl.innerHTML = `<span class="status-badge ${badge.class}">
        <span class="inline-block w-2 h-2 ${badge.dot} rounded-full"></span>${msg}</span>`;
      console.log(`[STATUS] ${msg}`);
    }

    function showLoading(msg = "Loading...", detail = "") {
      loadingText.textContent = msg;
      loadingDetail.textContent = detail;
      loadingOverlay.classList.remove("hidden");
    }

    function hideLoading() {
      loadingOverlay.classList.add("hidden");
    }

    function debounce(func, delay) {
      return function(...args) {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // ==================== MOBILE DRAWER ====================
    let drawerOpen = false;
    
    drawerHandle.addEventListener('click', toggleDrawer);
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      drawerOpen = true;
      mobileDrawer.classList.add('open');
    });
    
    function toggleDrawer(e) {
      e.preventDefault();
      drawerOpen = !drawerOpen;
      mobileDrawer.classList.toggle('open', drawerOpen);
    }

    // ==================== PAN & ZOOM ====================
    function initPanZoom() {
      if (!svgElement) return;
      
      const vb = svgElement.getAttribute("viewBox");
      if (vb) {
        const parts = vb.split(/\s+|,/).map(Number);
        viewBox = { x: parts[0], y: parts[1], width: parts[2], height: parts[3] };
      } else {
        const bbox = svgElement.getBBox();
        viewBox = { x: bbox.x, y: bbox.y, width: bbox.width, height: bbox.height };
        svgElement.setAttribute("viewBox", `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
      }
      
      svgElement.addEventListener("wheel", (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 1.1 : 0.9;
        zoom(delta, e.offsetX, e.offsetY);
      }, { passive: false });
      
      svgElement.addEventListener("mousedown", startPan);
      svgElement.addEventListener("mousemove", doPan);
      svgElement.addEventListener("mouseup", endPan);
      svgElement.addEventListener("mouseleave", endPan);
      
      svgElement.addEventListener("touchstart", handleTouchStart, { passive: false });
      svgElement.addEventListener("touchmove", handleTouchMove, { passive: false });
      svgElement.addEventListener("touchend", endPan);
      
      document.getElementById("zoom-controls").classList.remove("hidden");
    }
    
    function zoom(factor, mouseX = null, mouseY = null) {
      const newWidth = viewBox.width * factor;
      const newHeight = viewBox.height * factor;
      
      if (newWidth < viewBox.width * 0.1 || newWidth > viewBox.width * 10) return;
      
      if (mouseX !== null && mouseY !== null) {
        const rect = svgElement.getBoundingClientRect();
        const svgX = viewBox.x + (mouseX / rect.width) * viewBox.width;
        const svgY = viewBox.y + (mouseY / rect.height) * viewBox.height;
        
        viewBox.x = svgX - (mouseX / rect.width) * newWidth;
        viewBox.y = svgY - (mouseY / rect.height) * newHeight;
      } else {
        viewBox.x += (viewBox.width - newWidth) / 2;
        viewBox.y += (viewBox.height - newHeight) / 2;
      }
      
      viewBox.width = newWidth;
      viewBox.height = newHeight;
      
      updateViewBox();
    }
    
    function doPan(e) {
      if (!isPanning) return;
      
      const dx = e.clientX - startPoint.x;
      const dy = e.clientY - startPoint.y;
      
      const rect = svgElement.getBoundingClientRect();
      const scaleX = viewBox.width / rect.width;
      const scaleY = viewBox.height / rect.height;
      
      viewBox.x -= dx * scaleX;
      viewBox.y -= dy * scaleY;
      
      startPoint = { x: e.clientX, y: e.clientY };
      updateViewBox();
    }
    
    function endPan() {
      isPanning = false;
      if (svgElement) svgElement.style.cursor = "grab";
    }
    
    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        e.preventDefault();
        isPanning = true;
        startPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else if (e.touches.length === 2) {
        e.preventDefault();
        isPanning = false;
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        touchStartDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
      }
    }
    
    function handleTouchMove(e) {
      if (e.touches.length === 1 && isPanning) {
        e.preventDefault();
        
        const dx = e.touches[0].clientX - startPoint.x;
        const dy = e.touches[0].clientY - startPoint.y;
        
        const rect = svgElement.getBoundingClientRect();
        const scaleX = viewBox.width / rect.width;
        const scaleY = viewBox.height / rect.height;
        
        viewBox.x -= dx * scaleX;
        viewBox.y -= dy * scaleY;
        
        startPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        updateViewBox();
      } else if (e.touches.length === 2) {
        e.preventDefault();
        
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
        
        const factor = touchStartDistance / currentDistance;
        zoom(factor);
        touchStartDistance = currentDistance;
      }
    }
    
    function updateViewBox() {
      svgElement.setAttribute("viewBox", `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
    }
    
    function resetZoom() {
      if (!svgElement) return;
      
      const bbox = svgElement.getBBox();
      viewBox = { 
        x: bbox.x, 
        y: bbox.y, 
        width: bbox.width, 
        height: bbox.height 
      };
      
      updateViewBox();
    }

    // ==================== AUTO LOAD FILES ====================
    async function tryLoadFile(filenames, loader) {
      for (const filename of filenames) {
        try {
          console.log(`Trying: ${filename}`);
          loadingDetail.textContent = `Trying: ${filename}`;
          const result = await loader(filename);
          if (result) {
            console.log(`‚úÖ Loaded: ${filename}`);
            return filename;
          }
        } catch (error) {
          console.log(`‚ùå Failed: ${filename}`, error.message);
        }
      }
      return null;
    }

    async function loadSVGFromServer() {
      const loader = async (filename) => {
        const response = await fetch(filename);
        if (!response.ok) throw new Error(`Not found: ${filename}`);
        
        const text = await response.text();
        document.getElementById("svg-wrapper").innerHTML = text;

        svgElement = document.querySelector("#svg-wrapper svg");
        if (!svgElement) throw new Error("Invalid SVG");

        svgElement.style.width = "100%";
        svgElement.style.height = "100%";
        svgElement.style.cursor = "grab";

        initPanZoom();
        cacheBoothElements();

        console.log(`SVG: ${boothElements.size} elements`);
        return true;
      };

      const loaded = await tryLoadFile(CONFIG.svgFiles, loader);
      
      if (!loaded) {
        document.getElementById("svg-wrapper").innerHTML = `
          <div class="text-center px-4">
            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
            <p class="text-red-600 font-medium">Map file not found</p>
            <p class="text-sm text-gray-500 mt-2">Admin: Upload one of these files:</p>
            <p class="text-xs text-gray-400 mt-1">${CONFIG.svgFiles.join(', ')}</p>
          </div>
        `;
        return false;
      }
      
      return true;
    }

    async function loadDataFromServer() {
      const loader = async (filename) => {
        const response = await fetch(filename);
        if (!response.ok) throw new Error(`Not found: ${filename}`);
        
        let jsonData;
        
        if (filename.endsWith('.csv')) {
          const text = await response.text();
          const parsed = Papa.parse(text, {
            header: true,
            delimiter: ";",
            skipEmptyLines: true,
            encoding: "UTF-8"
          });
          jsonData = parsed.data;
        } else {
          const data = await response.arrayBuffer();
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
        }

        boothData = jsonData;
        buildBoothMap(jsonData);
        populateFilters(jsonData);
        
        console.log(`Data: ${jsonData.length} exhibitors`);
        return true;
      };

      const loaded = await tryLoadFile(CONFIG.dataFiles, loader);
      
      if (!loaded) {
        setStatus(`‚ö†Ô∏è Data file not found`, "warning");
        return false;
      }
      
      return true;
    }

    function cacheBoothElements() {
      boothElements.clear();
      
      const elementsWithIds = svgElement.querySelectorAll("[id]");
      elementsWithIds.forEach(el => {
        const id = el.id.trim();
        if (id) {
          boothElements.set(id.toUpperCase(), el);
        }
      });
      
      const textElements = svgElement.querySelectorAll("text, tspan");
      let textBoothCount = 0;
      
      textElements.forEach(el => {
        const textContent = el.textContent.trim();
        const boothPattern = /^[A-Z0-9]{2,}[A-Z][0-9]{2,}$/i;
        
        if (boothPattern.test(textContent)) {
          const upperID = textContent.toUpperCase();
          
          let targetElement = el;
          let parent = el.parentElement;
          
          while (parent && parent !== svgElement) {
            if (parent.tagName === 'g' || parent.tagName === 'rect' || parent.tagName === 'path') {
              targetElement = parent;
              break;
            }
            parent = parent.parentElement;
          }
          
          if (!boothElements.has(upperID)) {
            boothElements.set(upperID, targetElement);
            textBoothCount++;
          }
        }
      });
      
      console.log(`Cached ${boothElements.size} booths (${textBoothCount} from text)`);
    }

    function buildBoothMap(data) {
      boothMap = {};
      data.forEach(row => {
        const boothId = String(row["Stand_no"] || "").trim().toUpperCase();
        if (boothId) {
          boothMap[boothId] = row;
        }
      });
    }

    // ==================== BOOTH BINDING ====================
    function bindBooths() {
      if (!svgElement || !Object.keys(boothMap).length) {
        setStatus("‚ö†Ô∏è Missing data", "warning");
        return;
      }

      let matched = 0;
      let unmatched = 0;
      let vipCount = 0;
      let o2oCount = 0;

      boothElements.forEach((el, boothId) => {
        const boothInfo = boothMap[boothId];

        el.classList.remove("booth-highlighted", "booth-dimmed", "booth-selected", "booth-unmatched", "booth-vip", "booth-o2o");
        el.style.cursor = "default";
        el.style.opacity = "";
        el.style.filter = "";

        if (boothInfo) {
          matched++;
          el.style.cursor = "pointer";
          el.style.opacity = "1";
          
          // Check VIP and O2O status
          const isVIP = String(boothInfo["VIP"] || "").toLowerCase() === "yes" || String(boothInfo["VIP"] || "").toLowerCase() === "y";
          const isO2O = String(boothInfo["O2O"] || "").toLowerCase() === "yes" || String(boothInfo["O2O"] || "").toLowerCase() === "y";
          
          if (isVIP) {
            el.classList.add("booth-vip");
            vipCount++;
          }
          if (isO2O) {
            el.classList.add("booth-o2o");
            o2oCount++;
          }
          
          const newEl = el.cloneNode(true);
          el.parentNode.replaceChild(newEl, el);
          boothElements.set(boothId, newEl);
          
          newEl.addEventListener("mouseenter", (evt) => showTooltip(evt, boothInfo));
          newEl.addEventListener("mousemove", moveTooltip);
          newEl.addEventListener("mouseleave", hideTooltip);
          newEl.addEventListener("click", (e) => {
            e.stopPropagation();
            selectBooth(boothId, boothInfo);
          });
          newEl.addEventListener("touchend", (e) => {
            e.preventDefault();
            selectBooth(boothId, boothInfo);
          });
        } else {
          unmatched++;
          el.classList.add("booth-unmatched");
        }
      });

      console.log(`VIP: ${vipCount}, O2O: ${o2oCount}`);
      setStatus(`üéØ ${matched} booths (${vipCount} VIP, ${o2oCount} O2O)`, "success");
      updateStats();
      applyFilters();
    }

    // ==================== TOOLTIP ====================
    function showTooltip(evt, boothInfo) {
      if (isMobile) return;
      
      const company = boothInfo["Company name"] || "N/A";
      const boothId = boothInfo["Stand_no"] || "";
      const t1 = boothInfo["T1"] || "";
      const products = boothInfo["Exhibited products"] || "";
      const isVIP = String(boothInfo["VIP"] || "").toLowerCase() === "yes" || String(boothInfo["VIP"] || "").toLowerCase() === "y";
      const isO2O = String(boothInfo["O2O"] || "").toLowerCase() === "yes" || String(boothInfo["O2O"] || "").toLowerCase() === "y";

      let badges = '';
      if (isVIP) badges += '<span class="badge badge-vip">‚≠ê VIP</span> ';
      if (isO2O) badges += '<span class="badge badge-o2o">üîó O2O</span>';

      tooltip.innerHTML = `
        <div class="font-bold text-base mb-1">${company}</div>
        <div class="text-xs text-gray-300 mb-2">üìç Booth: ${boothId}</div>
        ${badges ? `<div class="mb-2">${badges}</div>` : ''}
        ${t1 ? `<div class="text-xs text-yellow-200">üìÇ ${t1}</div>` : ""}
        ${products ? `<div class="text-xs text-green-200 mt-1">üè∑Ô∏è ${products.substring(0, 60)}${products.length > 60 ? '...' : ''}</div>` : ""}
      `;
      tooltip.style.display = "block";
      moveTooltip(evt);
    }

    function moveTooltip(evt) {
      tooltip.style.left = (evt.pageX + 15) + "px";
      tooltip.style.top = (evt.pageY + 15) + "px";
    }

    function hideTooltip() {
      tooltip.style.display = "none";
    }

    // ==================== BOOTH SELECTION ====================
    function selectBooth(boothId, boothInfo) {
      if (selectedBoothId && boothElements.has(selectedBoothId)) {
        const prevEl = boothElements.get(selectedBoothId);
        prevEl.classList.remove("booth-selected");
      }

      selectedBoothId = boothId;
      const el = boothElements.get(boothId);
      if (el) {
        el.classList.add("booth-selected");
        el.style.opacity = "1";
      }

      displayBoothInfo(boothInfo);
      setTimeout(() => zoomToBooth(boothId), 100);
      
      if (isMobile) {
        mobileDrawer.classList.add('open');
        drawerOpen = true;
      }
    }

    function displayBoothInfo(booth) {
      const infoPanels = ['info-panel', 'info-panel-mobile'];
      const titles = ['info-title', 'info-title-mobile'];
      const contents = ['info-content', 'info-content-mobile'];
      
      infoPanels.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
      
      const titleText = booth["Company name"] || "Exhibitor Details";
      titles.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = titleText;
      });

      const isVIP = String(booth["VIP"] || "").toLowerCase() === "yes" || String(booth["VIP"] || "").toLowerCase() === "y";
      const isO2O = String(booth["O2O"] || "").toLowerCase() === "yes" || String(booth["O2O"] || "").toLowerCase() === "y";

      let badges = '';
      if (isVIP) badges += '<span class="badge badge-vip ml-2">‚≠ê VIP</span>';
      if (isO2O) badges += '<span class="badge badge-o2o ml-2">üîó O2O</span>';

      const fields = [
        { label: "Booth ID", key: "Stand_no" },
        { label: "Products", key: "Exhibited products", important: true },
        { label: "Category (T1)", key: "T1", important: true },
        { label: "Sub-category (T2)", key: "T2", important: true },
        { label: "Product Type (T3)", key: "T3", important: true },
        { label: "Exhibition Area", key: "Exhibition area" }
      ];

      let html = badges ? `<div class="mb-3">${badges}</div>` : "";
      
      fields.forEach(field => {
        const value = booth[field.key] || "-";
        const isImportant = field.important;
        
        if (value !== "-") {
          html += `
            <div class="info-row ${isImportant ? 'bg-blue-50' : ''}">
              <div class="info-label ${isImportant ? 'text-blue-800 font-semibold' : ''}">${field.label}:</div>
              <div class="info-value ${isImportant ? 'text-blue-900 font-medium' : ''}">${value}</div>
            </div>
          `;
        }
      });

      if (booth["International station link"]) {
        html += `
          <div class="mt-3">
            <a href="${booth["International station link"]}" target="_blank" 
               class="inline-block w-full text-center bg-gray-800 hover:bg-gray-900 text-white py-3 px-4 rounded-lg transition-colors text-sm font-medium">
              üåê Visit Company Website ‚Üí
            </a>
          </div>
        `;
      }

      contents.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      });
    }

    function zoomToBooth(boothId) {
      const el = boothElements.get(boothId);
      if (!el || !svgElement) return;

      try {
        const bbox = el.getBBox();
        const padding = Math.max(bbox.width, bbox.height) * 3;
        const targetWidth = bbox.width + padding;
        const targetHeight = bbox.height + padding;
        
        viewBox.x = bbox.x + bbox.width / 2 - targetWidth / 2;
        viewBox.y = bbox.y + bbox.height / 2 - targetHeight / 2;
        viewBox.width = targetWidth;
        viewBox.height = targetHeight;
        
        updateViewBox();
      } catch (error) {
        console.error('Zoom error:', error);
      }
    }

    // ==================== FILTERS ====================
    function populateFilters(data) {
      const categories = [...new Set(data.map(r => r["T1"]).filter(Boolean))].sort();
      const subCategories = [...new Set(data.map(r => r["T2"]).filter(Boolean))].sort();
      const productTypes = [...new Set(data.map(r => r["T3"]).filter(Boolean))].sort();
      
      populateSelect('filter-t1', categories, 'All Categories');
      populateSelect('filter-t2', subCategories, 'All Sub-categories');
      populateSelect('filter-t3', productTypes, 'All Product Types');
      
      populateSelect('filter-t1-mobile', categories, 'All Categories');
    }
    
    function populateSelect(id, options, defaultText) {
      const select = document.getElementById(id);
      if (!select) return;
      
      select.innerHTML = `<option value="">${defaultText}</option>`;
      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    const debouncedFilter = debounce(applyFilters, 300);

    function applyFilters() {
      if (!svgElement || !Object.keys(boothMap).length) return;

      const getFilterValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.toLowerCase().trim() : '';
      };
      
      const getCheckbox = (id) => {
        const el = document.getElementById(id);
        return el ? el.checked : false;
      };

      const filters = {
        company: getFilterValue(isMobile ? 'filter-company-mobile' : 'filter-company'),
        t1: getFilterValue(isMobile ? 'filter-t1-mobile' : 'filter-t1'),
        t2: getFilterValue('filter-t2'),
        t3: getFilterValue('filter-t3'),
        product: getFilterValue('filter-product'),
        vip: getCheckbox(isMobile ? 'filter-vip-mobile' : 'filter-vip'),
        o2o: getCheckbox(isMobile ? 'filter-o2o-mobile' : 'filter-o2o')
      };

      const hasActiveFilters = filters.company || filters.t1 || filters.t2 || filters.t3 || filters.product || filters.vip || filters.o2o;
      let visibleCount = 0;

      boothElements.forEach((el, boothId) => {
        const booth = boothMap[boothId];
        
        if (!booth) {
          el.classList.add("booth-dimmed");
          el.classList.remove("booth-highlighted");
          return;
        }

        let match = true;
        
        const isVIP = String(booth["VIP"] || "").toLowerCase() === "yes" || String(booth["VIP"] || "").toLowerCase() === "y";
        const isO2O = String(booth["O2O"] || "").toLowerCase() === "yes" || String(booth["O2O"] || "").toLowerCase() === "y";

        if (hasActiveFilters) {
          if (filters.company && !(booth["Company name"] || "").toLowerCase().includes(filters.company)) match = false;
          if (filters.t1 && !(booth["T1"] || "").toLowerCase().includes(filters.t1)) match = false;
          if (filters.t2 && !(booth["T2"] || "").toLowerCase().includes(filters.t2)) match = false;
          if (filters.t3 && !(booth["T3"] || "").toLowerCase().includes(filters.t3)) match = false;
          if (filters.product && !(booth["Exhibited products"] || "").toLowerCase().includes(filters.product)) match = false;
          if (filters.vip && !isVIP) match = false;
          if (filters.o2o && !isO2O) match = false;
        }

        if (match) {
          el.classList.remove("booth-dimmed");
          if (hasActiveFilters) {
            el.classList.add("booth-highlighted");
          } else {
            el.classList.remove("booth-highlighted");
          }
          visibleCount++;
        } else {
          el.classList.add("booth-dimmed");
          el.classList.remove("booth-highlighted");
        }
      });

      updateStats(visibleCount);
    }

    function resetFilters() {
      const ids = [
        'filter-company', 'filter-product', 'quick-search',
        'filter-company-mobile', 'quick-search-mobile'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      
      ['filter-t1', 'filter-t2', 'filter-t3', 'filter-t1-mobile'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      
      ['filter-vip', 'filter-o2o', 'filter-vip-mobile', 'filter-o2o-mobile'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });
      
      if (selectedBoothId && boothElements.has(selectedBoothId)) {
        boothElements.get(selectedBoothId).classList.remove("booth-selected");
      }
      selectedBoothId = null;
      
      ['info-panel', 'info-panel-mobile'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
      });
      
      applyFilters();
    }

    function updateStats(visible = null) {
      const total = Object.keys(boothMap).length;
      const svgBooths = boothElements.size;
      
      const text = visible !== null 
        ? `${visible} of ${total} exhibitors visible`
        : `${total} exhibitors | ${svgBooths} booths`;
      
      const statsEl = document.getElementById('stats');
      const statsMobileEl = document.getElementById('stats-mobile');
      if (statsEl) statsEl.textContent = text;
      if (statsMobileEl) statsMobileEl.textContent = text;
    }

    // ==================== QUICK SEARCH ====================
    function quickSearch(query) {
      query = query.trim().toUpperCase();
      if (!query) return;

      if (boothElements.has(query)) {
        const booth = boothMap[query];
        if (booth) {
          selectBooth(query, booth);
          setStatus(`‚úÖ Found: ${query}`, "success");
        }
      } else {
        setStatus(`‚ùå Not found: ${query}`, "warning");
      }
    }

    // ==================== EVENT LISTENERS ====================
    document.getElementById("reset-filters")?.addEventListener("click", resetFilters);
    document.getElementById("reset-filters-mobile")?.addEventListener("click", resetFilters);
    document.getElementById("reset-zoom")?.addEventListener("click", resetZoom);
    document.getElementById("reset-zoom-mobile")?.addEventListener("click", resetZoom);
    
    document.getElementById("zoom-in")?.addEventListener("click", () => zoom(0.8));
    document.getElementById("zoom-out")?.addEventListener("click", () => zoom(1.2));
    document.getElementById("zoom-reset")?.addEventListener("click", resetZoom);

    ["filter-company", "filter-product", "filter-company-mobile"].forEach(id => {
      document.getElementById(id)?.addEventListener("input", debouncedFilter);
    });
    
    ["filter-t1", "filter-t2", "filter-t3", "filter-t1-mobile"].forEach(id => {
      document.getElementById(id)?.addEventListener("change", applyFilters);
    });
    
    ["filter-vip", "filter-o2o", "filter-vip-mobile", "filter-o2o-mobile"].forEach(id => {
      document.getElementById(id)?.addEventListener("change", applyFilters);
    });

    document.getElementById("quick-search")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") quickSearch(e.target.value);
    });
    
    document.getElementById("quick-search-mobile")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") quickSearch(e.target.value);
    });

    window.addEventListener('resize', () => {
      isMobile = window.innerWidth <= 768;
    });

    // ==================== INITIALIZE ====================
    async function init() {
      console.log('üöÄ Initializing...');
      showLoading('Loading exhibition data...', 'Please wait...');
      
      const svgLoaded = await loadSVGFromServer();
      const dataLoaded = await loadDataFromServer();
      
      if (svgLoaded && dataLoaded) {
        bindBooths();
        setStatus('‚úÖ Exhibition ready', 'success');
      } else if (svgLoaded) {
        setStatus('‚ö†Ô∏è Map loaded, data missing', 'warning');
      } else {
        setStatus('‚ùå Failed to load files', 'warning');
      }
      
      hideLoading();
    }

    if (CONFIG.autoLoad) {
      init();
    }
  </script>
</body>
</html>
